# Proxmox Homelab Game Servers Stack
# Uses Docker Compose Profiles to manage resources efficiently.
# Common services (Watchtower, Promtail, cAdvisor) run always.
# Games run only when their specific profile is activated.

name: gameservers

networks:
  gameserver-net:
    driver: bridge

services:
  # ---------------------------------------------------------------------------
  # Core Services (Always Running)
  # ---------------------------------------------------------------------------
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: unless-stopped
    ports:
      - "8082:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    privileged: true
    environment:
      - TZ=${TZ:-Europe/Istanbul}
    command:
      - '--housekeeping_interval=10s'
      - '--docker_only=true'
      - '--store_container_labels=false'
    networks:
      - gameserver-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  promtail:
    image: grafana/promtail:latest
    container_name: promtail-gameservers
    restart: unless-stopped
    network_mode: "host"
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/log:/var/log:ro
      - /etc/promtail:/etc/promtail:ro
      - /var/lib/promtail/positions:/var/lib/promtail/positions
    command: -config.file=/etc/promtail/promtail.yml
    environment:
      - TZ=${TZ:-Europe/Istanbul}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  watchtower:
    image: ghcr.io/nicholas-fedor/watchtower:latest
    container_name: watchtower-gameservers
    environment:
      - TZ=${TZ:-Europe/Istanbul}
      - WATCHTOWER_CLEANUP=${WATCHTOWER_CLEANUP:-true}
      - WATCHTOWER_POLL_INTERVAL=${WATCHTOWER_POLL_INTERVAL:-3600}
      - WATCHTOWER_ROLLING_RESTART=true
      - PUID=1000
      - PGID=1000
      - UMASK=002
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - gameserver-net
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Palworld Server (Profile: palworld)
  # Start with: docker compose --profile palworld up -d
  # ---------------------------------------------------------------------------
  palworld-server:
    image: thijsvanloef/palworld-server-docker:latest
    container_name: palworld-server
    profiles: ["palworld"]
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Istanbul
      # --- Server Identity & Security ---
      - SERVER_NAME=${PALWORLD_SERVER_NAME}
      - SERVER_DESCRIPTION=${PALWORLD_SERVER_DESCRIPTION}
      - SERVER_PASSWORD=${PALWORLD_SERVER_PASSWORD}
      - ADMIN_PASSWORD=${PALWORLD_ADMIN_PASSWORD}
      - COMMUNITY_SERVER=${PALWORLD_COMMUNITY_SERVER:-false}
      - PUBLIC_IP=${PALWORLD_PUBLIC_IP}
      - PUBLIC_PORT=8211
      - MAX_PLAYERS=${PALWORLD_MAX_PLAYERS:-4}
      - USEAUTH=false
      
      # --- Performance & System ---
      - MULTITHREAD_ENABLED=true
      - UPDATE_ON_BOOT=true
      - RCON_ENABLED=true
      
      # --- REST API (Enabled for management) ---
      - REST_API_ENABLED=true
      - REST_API_PORT=8212

      # --- Backup Settings ---
      - BACKUP_ENABLED=true
      - BACKUP_CRON_EXPRESSION=0 */6 * * *
      - DELETE_OLD_BACKUPS=true
      - OLD_BACKUP_DAYS=7

      # --- Auto Reboot (Memory Leak Protection) ---
      - AUTO_REBOOT_ENABLED=true
      - AUTO_REBOOT_CRON_EXPRESSION=0 4 * * *

      # --- Solo / AFK Friendly Game Settings ---
      - DEATH_PENALTY=Item                    # Drops items only (Keeps equipment/Pals)
      - COLLECTION_DROP_RATE=2.0              # 2x Resources (Balanced for solo)
      - WORK_SPEED_RATE=1.5                   # 50% Faster crafting
      - PAL_EGG_DEFAULT_HATCHING_TIME=0       # Instant hatching
      - AUTO_PAUSE_ENABLED=false              # Keep running for AFK farming
      - ENABLE_NON_LOGIN_PENALTY=false        # No penalty for offline days
      - AUTO_SAVE_SPAN=300                    # Auto-save every 5 minutes
      - BASE_CAMP_WORKER_MAX_NUM=50           # Increase base workers to 50
      
    volumes:
      - /root/palworld:/palworld
      - /datapool/config/palworld/Saved:/palworld/Pal/Saved
      - /datapool/config/palworld/backups:/palworld/backups
      - /datapool/config/palworld/mods:/palworld/Pal/Content/Paks/~mods:ro
    ports:
      - "8211:8211/udp"  # Game port
      - "27015:27015/udp"  # Query port
      - "8212:8212/tcp"  # REST API
    networks:
      - gameserver-net
    restart: unless-stopped
    stop_grace_period: 120s
    healthcheck:
      test: ["CMD-SHELL", "netstat -an | grep -q ':8211'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # Satisfactory Server (Profile: satisfactory)
  # Start with: docker compose --profile satisfactory up -d
  # ---------------------------------------------------------------------------
  satisfactory-server:
    image: wolveix/satisfactory-server:latest
    container_name: satisfactory-server
    profiles: ["satisfactory"]
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Istanbul
      - SERVERNAME=${SATISFACTORY_SERVERNAME}
      - PASSWORD=${SATISFACTORY_PASSWORD}
      - PLAYERS=${SATISFACTORY_MAXPLAYERS:-10}
      - PUBLIC=false
      - AUTOSAVEINTERVAL=300
      - AUTOSAVENUM=20
      - CRASHREPORT=false
    volumes:
      - /datapool/config/satisfactory:/config
      - /root/satisfactory:/config/gamefiles
    ports:
      - "7777:7777/udp"  # Game port
      - "7777:7777/tcp"  # Game port TCP
      - "15000:15000/udp"  # Query port
      - "15777:15777/udp"  # Beacon port
    networks:
      - gameserver-net
    restart: unless-stopped
    stop_grace_period: 120s
    healthcheck:
      test: ["CMD-SHELL", "netstat -an | grep -q ':7777'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
